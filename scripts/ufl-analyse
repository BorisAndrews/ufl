#!/usr/bin/env python

import sys
import webbrowser
import ufl
from ufl.algorithms import basisfunctions, coefficients, unique_elements, load_forms, validate_form, ufl2latex, tree_format

# Get commandline options

args = sys.argv[1:]

# Pass latex code to www.texify.com (doesn't seem to work for long forms)
enable_browser = False
if "-w" in args:
    enable_browser = True
    args.remove("-w")

if len(args) == 0:
    print "Expecting .ufl file names."
    sys.exit(-1)
filenames = args
for filename in args:
    print
    
    if not filename.endswith(".ufl"):
        print "Warning: Filename '%s' doesn't end with .ufl." % filename

    # Load form file, which triggers many consistency
    # checks while the form is being built
    print "Loading form file '%s'" % filename
    forms = load_forms(filename)

    # Analyse validity of forms
    for k,v in forms:
        errors = validate_form(v)
        print
        if errors:
            print "Found errors in form '%s':" % k
            print errors
        else:
            print "Found no errors in form '%s'." % k

    # Print information about all forms
    for name, form in forms:
        # Extract information about forms
        bf = basisfunctions(form)
        cf = coefficients(form)
        elements = unique_elements(form)
        rank = len(bf)
        num_coefficients = len(cf)
        num_citg = len(form.cell_integrals())
        num_eitg = len(form.exterior_facet_integrals())
        num_iitg = len(form.interior_facet_integrals())
        
        # Pretty-print form information
        print
        print "Form info:"
        print "    Name: '%s'" % name
        print "    Rank:", rank
        print "    Number of coefficients:", num_coefficients
        print "    Number of cell integrals:", num_citg
        print "    Number of exterior facet integrals:", num_eitg
        print "    Number of interior facet integrals:", num_iitg
        print "    Elements used:"
        for e in elements:
            print "       ", repr(e)
        print "    Basisfunctions:"
        for v in bf:
            print "       ", repr(v)
        print "    Coefficients:"
        for w in cf:
            print "       ", repr(w)
        print
        print "Form representation:"
        print repr(form)
        print
        print "Form pretty-print:"
        print str(form)
        print
        print "Form tree formatting:"
        tree = tree_format(form)
        print tree
        print
        print "Form LaTeX code:"
        latex = ufl2latex(form)
        print latex
        if enable_browser:
            webbrowser.open("http://www.texify.com/$%s$" % latex.replace(" ",""))
    print

